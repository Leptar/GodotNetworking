#!/usr/bin/env python
import os

# Initialize the environment once
env = SConscript("godot-cpp/SConstruct")

# 2. Apply High-Performance Flags (Architecture specific)
if env["platform"] == "macos":
    # Force ARM64 for M4 chips
    env.Append(CCFLAGS=["-std=c++17", "-arch", "arm64"])
    env.Append(LINKFLAGS=["-arch", "arm64"])
    env["arch"] = "arm64" # Ensure this variable is set for the suffix logic
elif env["platform"] == "windows":
    env.Append(CCFLAGS=["/std:c++17", "/O2"]) 
elif env["platform"] == "linux":
    env.Append(CCFLAGS=["-std=c++17", "-O3"])

# --- 3. SUFFIX GENERATION LOGIC (THE FIX) ---
# Goal: Create strings like ".macos.template_debug.arm64.dylib"
# or ".windows.template_release.x86_64.dll"

# A. Determine File Extension
if env["platform"] == "windows":
    lib_ext = ".dll"
elif env["platform"] == "macos":
    lib_ext = ".dylib"
else: 
    # Linux / BSD
    lib_ext = ".so"

# B. Determine Architecture (Fallback if not set)
# godot-cpp usually sets this, but we play it safe
if "arch" not in env:
    env["arch"] = "x86_64" # Default fallback

# C. Construct the Suffix
# Format: .{platform}.{target}.{arch}{extension}
# Example: .macos.template_debug.arm64.dylib
env["suffix"] = ".{}.{}.{}{}".format(
    env["platform"],
    env["target"], 
    env["arch"],
    lib_ext
)
# --------------------------------------------

# Export the environment so sub-scripts can use it
Export('env')

# Build the Sub-modules
SConscript("network/SConscript")